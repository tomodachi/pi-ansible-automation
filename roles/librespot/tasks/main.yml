---

- name: Copy librespot for arm pulseaudio enabled version
  become: true
  ansible.builtin.copy:
    src: files/librespot.arm64_pulse
    dest: /usr/local/bin/
    owner: root
    group: root
    mode: '655'

- name: Copy librespot and pulseaudio systemd service file
  become: true
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    owner: root
    group: root
    mode: '644'
  loop:
    - librespot.service
    - pulseaudio-system-wide.service
  tags: servicefile

- name: Install pulseaudio
  ansible.builtin.apt:
    name: pulseaudio
    state: present
    install_recommends: false

- name: Disable per user pulseaudio sessions
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: false
    state: stopped
    scope: global
  loop:
    - pulseaudio.service
    - pulseaudio.socket
  when: not ansible_check_mode

- name: Set default output to HDMI instead of analogue
  ansible.builtin.lineinfile:
    create: yes
    path: /etc/pulse/system.pa
    line: set-default-sink 1
    insertbefore: EOF
    owner: root
    group: root
    mode: '0644'

- name: Disable pulsaudio autospawn
  ansible.builtin.lineinfile:
    create: yes
    path: /etc/pulse/client.conf
    line: autospawn = no
    insertbefore: EOF

- name: Create librespot service user
  ansible.builtin.user:
    name: librespot
    groups: pulse-access
    system: true
    shell: /bin/false
    create_home: true
    state: present

- name: Enable librespot service
  become: true
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    daemon_reload: true
  when: not ansible_check_mode

  loop:
    - librespot
    - pulseaudio-system-wide
