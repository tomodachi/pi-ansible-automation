---

- name: Copy librespot for arm pulseaudio enabled version
  become: true
  copy:
    src: files/librespot.arm64_pulse
    dest: /usr/local/bin/
    owner: root
    group: root
    mode: 0655

- name: Copy librespot and pulseaudio systemd service file
  become: true
  template:
    src: "{{ item }}"
    dest: "/etc/systemd/system/{{ item }}"
    owner: root
    group: root
    mode: 0644
  loop:
    - librespot.service
    - pulseaudio-system-wide.service
  tags: servicefile

- name: Install pulseaudio
  apt:
    name: pulseaudio
    state: present
    install_recommends: no

- name: Disable per user pulseaudio sessions
  command:
    cmd: systemctl --global disable pulseaudio.service pulseaudio.socket

- name: Set deault output to HDMI instead of analogue
  lineinfile:
    path: /etc/pulse/system.pa
    line: set-default-sink 1
    insertbefore: EOF

- name: Disable pulsaudio autospawn
  lineinfile:
    path: /etc/pulse/client.conf
    line: autospawn = no
    insertbefore: EOF

- name: Create librespot service user
  user:
    name: librespot
    groups: pulse-access
    system: yes
    shell: /bin/false
    create_home: true
    state: present

- name: Enable librespot service
  become: true
  systemd:
    name: "{{ item }}"
    state: started
    enabled: true
    daemon_reload: yes
  loop:
    - librespot
    - pulseaudio-system-wide
